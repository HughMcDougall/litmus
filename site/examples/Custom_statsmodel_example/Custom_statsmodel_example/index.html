
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Hugh McDougall">
      
      
        <link rel="canonical" href="https://github.com/HughMcDougall/litmus/examples/Custom_statsmodel_example/Custom_statsmodel_example/">
      
      
        <link rel="prev" href="../../lightcurve_gentest/lightcurve_gentest/">
      
      
        <link rel="next" href="../../Model_comparison_example/Model_comparison_example/">
      
      
      <link rel="icon" href="../../../assets/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>Creating a Custom Statistical Model - LITMUS</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../custom.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#custom-stats_model-example" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="LITMUS" class="md-header__button md-logo" aria-label="LITMUS" data-md-component="logo">
      
  <img src="../../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LITMUS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Creating a Custom Statistical Model
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="deep-orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/HughMcDougall/litmus/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    HughMcDougall/litmus/
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="LITMUS" class="md-nav__button md-logo" aria-label="LITMUS" data-md-component="logo">
      
  <img src="../../../assets/logo.png" alt="logo">

    </a>
    LITMUS
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/HughMcDougall/litmus/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    HughMcDougall/litmus/
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Code Docs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Code Docs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    For Users
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            For Users
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../fitting_methods/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    fittingmethods
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../litmusclass/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    litmusclass
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lightcurve/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lightcurve
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../mocks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mocks
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    For Developers
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            For Developers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lin_scatter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lin_scatter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../GP_working/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GP_working
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../logging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    logging
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../_utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utilities and Typing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Examples & Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Examples & Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../gettingstarted/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../JAVELIN_HeScan_Comparison/JAVELIN_HeScan_Comparison/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LITMUS vs Aliasing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lightcurve_gentest/lightcurve_gentest/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Constraining a Lightcurve
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Creating a Custom Statistical Model
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Creating a Custom Statistical Model
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#an-imaginary-survey" class="md-nav__link">
    <span class="md-ellipsis">
      An Imaginary Survey
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-stats" class="md-nav__link">
    <span class="md-ellipsis">
      The Stats
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-the-stats_model-model" class="md-nav__link">
    <span class="md-ellipsis">
      Building the stats_model Model
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Model_comparison_example/Model_comparison_example/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Litmus to Remove False Positives
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="custom-stats_model-example">Custom <code>stats_model</code> Example</h1>
<p>Using <code>LITMUS</code> but finding that the existing stats models just aren't what you're after: Good news, <code>LITMUS</code>'s modular design means you can write your own stats model or extend an existing one as easily as you like. In this example we'll show an example of adding PyRoa-style uncertainty calibration from an imaginary survey with two photometric telescopes. In this example we work in the format of a notebook, but in actuality you'd likely write your extension modules in a <code>.py</code> file</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">litmus.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">_default_config</span><span class="p">,</span> <span class="n">stats_model</span><span class="p">,</span> <span class="n">quickprior</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">litmus.gp_working</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpw</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">litmus</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">litmus._utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">dict_extend</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpyro</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpyro.distributions</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dist</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>An NVIDIA GPU may be present on this machine, but a CUDA-enabled jaxlib is not installed. Falling back to cpu.
</code></pre></div>

<h2 id="an-imaginary-survey">An Imaginary Survey</h2>
<p>First up, we need to actually generate our fake data. Let's imagine a ficticious (but reasonable) scenario like this:
1. Like OzDES, we have multi-year parallel observations of OzDES spectroscopy and DES-like phometry data for the first three years
2. Oops! Something went wrong and we lost the last three years of photometry!
3. Good news! A second survey (Let's call it DESOz) happened to observe the same target for the last three years!
4. Oh no! DESOZ has some unaccounted source of error $E_\mathrm{calib}$ that isn't accounted for in its measurement uncertainties!</p>
<p>This example may be a little unrealisitc, but it has the vague shape of a practical application and so we'll proceed anyway. First up, let's simulate the imaginary data, per usual equipped with all the true underlying values.</p>
<p>First, use the <code>mocks</code> module to get some OzDES/DES-like data:</p>
<div class="codehilite"><pre><span></span><code><span class="n">seed</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">mock_underlying</span> <span class="o">=</span> <span class="n">litmus</span><span class="o">.</span><span class="n">mocks</span><span class="o">.</span><span class="n">mock</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">maxtime</span><span class="o">=</span><span class="mi">360</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span> <span class="n">E</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>
<span class="n">phot_lc_1</span><span class="p">,</span> <span class="n">spec_lc</span> <span class="o">=</span> <span class="n">mock_underlying</span><span class="o">.</span><span class="n">lc_1</span><span class="p">,</span> <span class="n">mock_underlying</span><span class="o">.</span><span class="n">lc_2</span>
</code></pre></div>

<p>Now, we'll trim the photometry lightcurve, <code>phot_lc_1</code>, to the first three years and generate a second mock with a <em>slightly</em> higher measurement uncertainty, which we'll then trim to the <em>second</em> three years. We'll then bring the "recorded" uncertainty back down. This means that the <code>phot_lc_2</code> now has its measurement uncertainty under-estimated, which we can see by how the corresponding points scatter about the true underlying lightcurve:</p>
<div class="codehilite"><pre><span></span><code><span class="n">phot_lc_1</span> <span class="o">=</span> <span class="n">phot_lc_1</span><span class="o">.</span><span class="n">trimmed_copy</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mi">360</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">E_calib_true</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">mock_2</span> <span class="o">=</span> <span class="n">litmus</span><span class="o">.</span><span class="n">mocks</span><span class="o">.</span><span class="n">mock</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">maxtime</span><span class="o">=</span><span class="mi">360</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span>
                           <span class="n">E</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">0.01</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">E_calib_true</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">])</span>
<span class="n">phot_lc_2</span> <span class="o">=</span> <span class="n">mock_2</span><span class="o">.</span><span class="n">lc_1</span><span class="o">.</span><span class="n">trimmed_copy</span><span class="p">(</span><span class="mi">360</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">360</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">phot_lc_2</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">phot_lc_2</span><span class="o">.</span><span class="n">E</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">E_calib_true</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">phot_lc</span> <span class="o">=</span> <span class="n">phot_lc_1</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">phot_lc_2</span><span class="p">)</span>

<span class="c1">#-----------</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">phot_lc_1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;DES Photometry&quot;</span><span class="p">)</span>
<span class="n">phot_lc_2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;DESOz Photometry&quot;</span><span class="p">)</span>
<span class="n">spec_lc</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:purple&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Spectroscopy (300 day lag)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mock_underlying</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">mock_underlying</span><span class="o">.</span><span class="n">lc</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True Photometry&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Signal Strength (Arb)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (Days)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<p><img alt="png" src="../output_5_0.png" /></p>
<h2 id="the-stats">The Stats</h2>
<p>Before we code a statistical model, we need to know what that model looks like exactly. In this case, it's a relatively simple change to the normal <code>GP_simple</code> model, but with one addition: we need <code>E_calib</code> to be some unknown factor near unity by which we correct the DESOz measurement errors. As a Bayesian model we need some sort of prior, and given we now that <code>E_calib</code> is close to zero an exponential distribution makes sense</p>
<p>\begin{equation}
\pi(E_\mathrm{calib}) \propto \exp(lambda\timesE_\mathrm{calib})
\end{equation}</p>
<p>Then we'd up-scale our uncertainties by this amount, remembering that we add errors in quadrature instead of linearly:
\begin{equation}
E_i = \sqrt{E_i^0 + E_\mathrm{calib}}  \;\; \forall \;\; i \in {i_\mathrm{DESOz}}
\end{equation}
In NumPyro this looks something like:</p>
<div class="codehilite"><pre><span></span><code>E_calib = numpyro.sample(&#39;E_calib&#39;,numpyro.distributions.Exponential(0, lam))
E = jnp.sqrt(E**2 + jnp.where(survey==&quot;DESOz&quot;, E_calib, 0.0)**2)

...Typical GP sampling stuf...
</code></pre></div>

<p>Most of <code>LITMUS</code>'s models by default use uniform distributions, or at least distributions with hard boundaries, so we're playing a bit fast and loose with convention here. Still, for an ad-hoc example we can be a little shotgun with convention.</p>
<p>We need know we need to keep track of which survey generated each measurement in each lightcurve, so let's staple those onto the lightcurve objects now:</p>
<div class="codehilite"><pre><span></span><code><span class="n">phot_lc</span><span class="o">.</span><span class="n">survey</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="p">[</span><span class="s2">&quot;DES&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">phot_lc</span><span class="o">.</span><span class="n">T</span> <span class="o">&lt;</span> <span class="mi">360</span> <span class="o">*</span> <span class="mi">3</span><span class="p">),</span> <span class="o">*</span><span class="p">[</span><span class="s2">&quot;DESOz&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">phot_lc</span><span class="o">.</span><span class="n">T</span> <span class="o">&gt;=</span> <span class="mi">360</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)]</span>
<span class="n">spec_lc</span><span class="o">.</span><span class="n">survey</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;OzDES&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spec_lc</span><span class="o">.</span><span class="n">N</span>
</code></pre></div>

<h2 id="building-the-stats_model-model">Building the <code>stats_model</code> Model</h2>
<p>The minimum amount of things you need to build a <code>stats_model</code> in litmus is:
1. A way of turning lightcurves into data (<code>.lc_to_data()</code>),
2. A prior (<code>.prior()</code>), with default ranges (<code>._default_prior_ranges</code>), and
3. A model likelihood function (<code>.model_function(data)</code>)</p>
<p>Our model, lets call it <code>GP_simple_Ecalib</code> is an extension to the GP_simple model, so it inherits most of the bells and whistles out of the box. We only really need to specify the bits that change. Of the functions here, most are copy-pasted from the original <code>GP_simple</code> source-code with only a few extra lines added, but you can see how the moving parts work.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GP_simple_Ecalib</span><span class="p">(</span><span class="n">litmus</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">GP_simple</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prior_ranges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_prior_ranges</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;E_calib&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">prior_ranges</span><span class="o">=</span><span class="n">prior_ranges</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># ----------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">lc_to_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lc_1</span><span class="p">:</span> <span class="n">lightcurve</span><span class="p">,</span> <span class="n">lc_2</span><span class="p">:</span> <span class="n">lightcurve</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">lc_1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">*</span><span class="n">lc_2</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">lc_1</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="o">*</span><span class="n">lc_2</span><span class="o">.</span><span class="n">Y</span><span class="p">])</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">lc_1</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="o">*</span><span class="n">lc_2</span><span class="o">.</span><span class="n">E</span><span class="p">])</span>
        <span class="n">bands</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lc_1</span><span class="o">.</span><span class="n">N</span><span class="p">),</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">lc_2</span><span class="o">.</span><span class="n">N</span><span class="p">)])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">survey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">*</span><span class="n">lc_1</span><span class="o">.</span><span class="n">survey</span><span class="p">,</span> <span class="o">*</span><span class="n">lc_2</span><span class="o">.</span><span class="n">survey</span><span class="p">])</span>  <span class="c1"># &lt;---------- New!</span>
        <span class="n">survey</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">survey</span> <span class="o">==</span> <span class="s2">&quot;DESOz&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">I</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>

        <span class="n">T</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">bands</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">E</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">bands</span><span class="p">[</span><span class="n">I</span><span class="p">]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
                <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">Y</span><span class="p">,</span>
                <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="n">E</span><span class="p">,</span>
                <span class="s1">&#39;bands&#39;</span><span class="p">:</span> <span class="n">bands</span><span class="p">,</span>
                <span class="s2">&quot;survey&quot;</span><span class="p">:</span> <span class="n">survey</span>  <span class="c1"># &lt;---------- New! </span>
                <span class="p">}</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prior</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lag</span><span class="p">,</span> <span class="n">logtau</span><span class="p">,</span> <span class="n">logamp</span><span class="p">,</span> <span class="n">rel_amp</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">rel_mean</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">prior</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">lam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_ranges</span><span class="p">[</span><span class="s1">&#39;E_calib&#39;</span><span class="p">]</span>  <span class="c1"># &lt;---------- New!</span>
        <span class="n">E_calib</span> <span class="o">=</span> <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;E_calib&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="n">lam</span><span class="p">))</span>  <span class="c1"># &lt;---------- New!</span>
        <span class="k">return</span> <span class="n">lag</span><span class="p">,</span> <span class="n">logtau</span><span class="p">,</span> <span class="n">logamp</span><span class="p">,</span> <span class="n">rel_amp</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">rel_mean</span><span class="p">,</span> <span class="n">E_calib</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">model_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">lag</span><span class="p">,</span> <span class="n">logtau</span><span class="p">,</span> <span class="n">logamp</span><span class="p">,</span> <span class="n">rel_amp</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">rel_mean</span><span class="p">,</span> <span class="n">E_calib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior</span><span class="p">()</span>

        <span class="n">T</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">survey</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;bands&#39;</span><span class="p">,</span> <span class="s2">&quot;survey&quot;</span><span class="p">]]</span>

        <span class="n">E</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">E</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">survey</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E_calib</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># &lt;---- The magic line!</span>

        <span class="c1"># Conversions to gp-friendly form</span>
        <span class="n">amp</span><span class="p">,</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logamp</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logtau</span><span class="p">)</span>

        <span class="n">diag</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>

        <span class="n">delays</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">lag</span><span class="p">])</span>
        <span class="n">amps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">amp</span><span class="p">,</span> <span class="n">rel_amp</span> <span class="o">*</span> <span class="n">amp</span><span class="p">])</span>
        <span class="n">means</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mean</span><span class="p">,</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">rel_mean</span><span class="p">])</span>

        <span class="n">T_delayed</span> <span class="o">=</span> <span class="n">T</span> <span class="o">-</span> <span class="n">delays</span><span class="p">[</span><span class="n">bands</span><span class="p">]</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">T_delayed</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>

        <span class="c1"># Build and sample GP</span>

        <span class="n">gp</span> <span class="o">=</span> <span class="n">gpw</span><span class="o">.</span><span class="n">build_gp</span><span class="p">(</span><span class="n">T_delayed</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">diag</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">bands</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">tau</span><span class="p">,</span> <span class="n">amps</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">basekernel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basekernel</span><span class="p">)</span>
        <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">gp</span><span class="o">.</span><span class="n">numpyro_dist</span><span class="p">(),</span> <span class="n">obs</span><span class="o">=</span><span class="n">Y</span><span class="p">[</span><span class="n">I</span><span class="p">])</span>
</code></pre></div>

<p>Now let's create an instance of this model and test to see if it actually works. First, we'll generate a bunch of samples to make sure it understands its prior properly:</p>
<div class="codehilite"><pre><span></span><code><span class="n">lam</span> <span class="o">=</span> <span class="mf">4.0</span>
<span class="n">model_instance</span> <span class="o">=</span> <span class="n">GP_simple_Ecalib</span><span class="p">(</span><span class="n">prior_ranges</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;E_calib&quot;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span> <span class="n">lam</span><span class="p">]},</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">prior_samples</span> <span class="o">=</span> <span class="n">model_instance</span><span class="o">.</span><span class="n">prior_sample</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">32</span><span class="p">)</span>

<span class="c1">#--------</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">prior_samples</span><span class="p">[</span><span class="s1">&#39;E_calib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">lam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">X</span><span class="o">*</span><span class="n">lam</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span> <span class="s1">&#39;navy&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Expected Prior&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">prior_samples</span><span class="p">[</span><span class="s1">&#39;E_calib&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;orchid&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Prior Samples&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Samples Drawn from Prior Distribution of $E_\mathrm</span><span class="si">{calib}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$E_\mathrm</span><span class="si">{calib}</span><span class="s2">$&quot;</span><span class="p">),</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Prior Density&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(),</span> <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<p><img alt="png" src="../output_12_0.png" /></p>
<p>Let's also make sure that our statistical model has enough constraining power to actually <em>measure</em> $E_\mathrm{calib}$, and confirm that <code>.model_function()</code> and <code>.lc_to_data()</code> are working properly. Because we chose a vague prior the posterior density is heavily likelihood dominated and, thankfully, near-gaussian which means we can safely use the <code>hessian_scan</code>. </p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Convert lightcurves to data with .lc_to_data()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">model_instance</span><span class="o">.</span><span class="n">lc_to_data</span><span class="p">(</span><span class="n">phot_lc</span><span class="p">,</span> <span class="n">spec_lc</span><span class="p">)</span>

<span class="c1"># Create a bunch of test samples with all parameters except E_calib fixed at truth</span>
<span class="n">E_calib_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
<span class="n">test_params</span> <span class="o">=</span> <span class="n">dict_extend</span><span class="p">(</span><span class="n">mock_underlying</span><span class="o">.</span><span class="n">params</span><span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;E_calib&#39;</span><span class="p">:</span> <span class="n">E_calib_test</span><span class="p">})</span>

<span class="c1"># Calculate prior, likelihood and log density</span>
<span class="n">log_prior</span> <span class="o">=</span> <span class="n">model_instance</span><span class="o">.</span><span class="n">log_prior</span><span class="p">(</span><span class="n">test_params</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">log_density</span> <span class="o">=</span> <span class="n">model_instance</span><span class="o">.</span><span class="n">log_density</span><span class="p">(</span><span class="n">test_params</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">log_likelihood</span> <span class="o">=</span> <span class="n">log_density</span> <span class="o">-</span> <span class="n">log_prior</span>

<span class="c1">#--------------------------------</span>
<span class="c1"># Plot!</span>
<span class="n">f</span><span class="p">,</span> <span class="p">[</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">a1</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">]:</span>
    <span class="n">a</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_params</span><span class="p">[</span><span class="s1">&#39;E_calib&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_prior</span> <span class="o">-</span> <span class="n">log_prior</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Log Prior&quot;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;navy&#39;</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_params</span><span class="p">[</span><span class="s1">&#39;E_calib&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_density</span> <span class="o">-</span> <span class="n">log_density</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Log Density&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span> <span class="s1">&#39;midnightblue&#39;</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_params</span><span class="p">[</span><span class="s1">&#39;E_calib&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_likelihood</span> <span class="o">-</span> <span class="n">log_likelihood</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Log likelihood&quot;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;salmon&#39;</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">E_calib_true</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Truth, E_calib = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">E_calib_true</span><span class="p">)</span>
    <span class="n">a</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
    <span class="n">a</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="n">a1</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center right&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">E_calib_test</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">E_calib_test</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">a1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Log Density, Conditional&quot;</span><span class="p">)</span>
<span class="n">a2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Density, Conditional&quot;</span><span class="p">)</span>

<span class="n">f</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s2">&quot;$E_\mathrm</span><span class="si">{calib}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<p><img alt="png" src="../output_14_0.png" /></p>
<p>Enough validation and testing. Let's see how it performs with actual fitting via the <code>hessian_scan</code>. By default, everything should perform nice and smoothly without any alteration. Let's see how we've done:</p>
<div class="codehilite"><pre><span></span><code><span class="n">my_fitter</span> <span class="o">=</span> <span class="n">litmus</span><span class="o">.</span><span class="n">fitting_methods</span><span class="o">.</span><span class="n">hessian_scan</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="n">Nlags</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">my_fitter</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">phot_lc</span><span class="p">,</span> <span class="n">spec_lc</span><span class="p">)</span>
</code></pre></div>

<p>Now slotting this into a plotter and firing off the contours, we find that we've succeeded in constraining the calibration uncertainty! Notice that $E_\mathrm{calib}$ and $\ln \vert \tau \vert$ (<code>E_calib</code> and <code>logtau</code>) are slightly correlated. If we hadn't included this error calibration, we would have ended up with a model that:
1. Drastically under-estimated the timescale of variation to try and wiggle through the extra noise
2. Had a markedly lower model evidence, obscuring the strength of our lag recovery</p>
<div class="codehilite"><pre><span></span><code><span class="n">lt</span> <span class="o">=</span> <span class="n">LITMUS</span><span class="p">(</span><span class="n">my_fitter</span><span class="p">)</span>
<span class="n">lt</span><span class="o">.</span><span class="n">plot_parameters</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">truth</span><span class="o">=</span><span class="n">mock_underlying</span><span class="o">.</span><span class="n">params</span><span class="p">()</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;E_calib&#39;</span><span class="p">:</span> <span class="n">E_calib_true</span><span class="p">},</span>
                   <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lag&quot;</span><span class="p">,</span> <span class="s2">&quot;logtau&quot;</span><span class="p">,</span> <span class="s2">&quot;E_calib&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Warning! LITMUS object built on pre-run fitting_procedure. May have unexpected behaviour.
</code></pre></div>

<p><img alt="png" src="../output_18_2.png" /></p>
<p>This is a pretty simple example of setting up a custom <code>stats_model</code>, but by and large even more complicated applications will follow these processes. Some things not covered here are:
1. Updating the <code>.find_seed()</code> function to make common sense a-priori guesses for any new parameters you introduce. By default 
<code>GP_simple</code> or other models will blindly sample the prior until they get a decent hit for these
2. Updating <code>._gen_lightcurves()</code> to properly predict the underlying lightcurves. This is very similar to updating <code>model_function</code> but taking in an argument <code>Tpred</code> for time and returning a covariance matrix. See the source code for <code>GP_simple</code> and its null hypothesis variants for examples
3. If you decide to use a non-uniform prior for <code>lag</code>, you'll need to make sure it still has hard boundaries as defined in <code>prior_ranges</code> and will need to update <code>.uncon_grad_lag()</code> so that fitting methods understand how to transit between the constrained and unconstrained domains. See <code>GP_simple_normalprior</code> for an example.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["search.suggest", "search.highlight", "search.tabs.link", "navigation.expand", "toc.follow", "navigation.tracking", "toc.integrate", "content.code.copy", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>